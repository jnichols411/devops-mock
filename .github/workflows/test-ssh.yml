name: Test SSH to VM

on:
  workflow_dispatch:

jobs:
  ssh-test:
    runs-on: ubuntu-latest

    steps:
    - name: Set up SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.MOCK_DEV_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -p 2222 -H ${{ secrets.MOCK_DEV_IP_ADDRESS }} >> ~/.ssh/known_hosts

        # Start the ssh-agent and add the SSH key with passphrase
        # eval "$(ssh-agent -s)"  # Start the ssh-agent
        # echo "${{ secrets.MOCK_DEV_SSH_PASSPHRASE }}" | ssh-add -p ~/.ssh/id_rsa  # Add the private key to the agent with the passphrase

    - name: Debug SSH key and known_hosts
      run: |
        echo "Private key length: $(wc -c < ~/.ssh/id_rsa)"
        ls -la ~/.ssh  # Debugging: check permissions and key location
        cat ~/.ssh/known_hosts  # Debugging: check known_hosts file

    - name: Test SSH connection
      run: |
        # ssh -o StrictHostKeyChecking=no -p 2222 ${{ secrets.MOCK_DEV_USERNAME }}@${{ secrets.MOCK_DEV_IP_ADDRESS }} "echo 'Connected! Creating test folder...'; mkdir -p ~/github-action-test && echo '✅ Done.'"
        ssh -i ~/.ssh/id_rsa -p 2222 ${{ secrets.MOCK_DEV_USERNAME }}@${{ secrets.MOCK_DEV_IP_ADDRESS }} "echo 'Connected! Creating test folder...'; mkdir -p ~/github-action-test && echo '✅ Done.'"
